<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System & Modbus Control Panel</title>
    <script src="scripts/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }


        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }


        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }


        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 20px;
        }


        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }


        .header p {
            color: #666;
            font-size: 1em;
        }


        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }


        .status-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }


        .status-item label {
            font-weight: bold;
            color: #667eea;
            display: block;
            font-size: 0.8em;
            margin-bottom: 5px;
        }


        .status-item .value {
            font-size: 1.2em;
            color: #333;
            font-weight: bold;
        }


        .status-item .unit {
            font-size: 0.8em;
            color: #999;
        }


        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }


        .tab-button {
            padding: 12px 25px;
            background: #f0f0f0;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            color: #666;
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0;
        }


        .tab-button:hover {
            background: #e0e0e0;
        }


        .tab-button.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
        }


        .tab-content {
            display: none;
        }


        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }


        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }


        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 2px solid #e0e0e0;
            position: relative;
            min-height: 350px;
        }


        .chart-container h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
            text-align: center;
        }


        .chart-wrapper {
            position: relative;
            height: 300px;
        }


        .channels-section {
            margin-bottom: 30px;
        }


        .section-title {
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }


        .channels-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }


        .channels-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }


        .channels-table th {
            padding: 18px;
            text-align: left;
            font-size: 0.95em;
        }


        .channels-table td {
            padding: 18px;
            border-bottom: 1px solid #e0e0e0;
        }


        .channels-table tbody tr:hover {
            background: #f5f5f5;
            transition: background 0.2s ease;
        }


        .channels-table tbody tr:last-child td {
            border-bottom: none;
        }


        .channel-name {
            font-weight: bold;
            color: #667eea;
            min-width: 80px;
        }


        .channel-value {
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
            min-width: 60px;
        }


        .value-positive {
            color: #27ae60;
        }


        .value-negative {
            color: #e74c3c;
        }


        .value-zero {
            color: #95a5a6;
        }


        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 200px;
        }


        .slider {
            flex: 1;
            height: 8px;
            border-radius: 5px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }


        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: box-shadow 0.2s ease;
        }


        .slider::-webkit-slider-thumb:hover {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }


        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: box-shadow 0.2s ease;
        }


        .slider::-moz-range-thumb:hover {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }


        .slider-value {
            display: inline-block;
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9em;
            color: #667eea;
        }


        .input-container {
            display: flex;
            gap: 8px;
            align-items: center;
            min-width: 180px;
        }


        .input-container input {
            width: 70px;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.95em;
            text-align: center;
            transition: border-color 0.2s ease;
        }


        .input-container input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }


        .input-container input::-webkit-outer-spin-button,
        .input-container input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }


        .input-container input[type=number] {
            -moz-appearance: textfield;
        }


        .btn-set {
            padding: 10px 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            white-space: nowrap;
        }


        .btn-set:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }


        .btn-set:active {
            transform: translateY(0);
        }


        .feedback-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            display: none;
            animation: slideIn 0.3s ease;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            min-width: 300px;
        }


        .feedback-message.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
            display: block;
        }


        .feedback-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
            display: block;
        }


        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(400px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }


        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }


            .channels-table {
                font-size: 0.9em;
            }


            .channels-table th,
            .channels-table td {
                padding: 12px;
            }
        }


        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }


            .header h1 {
                font-size: 1.8em;
            }


            .status-bar {
                grid-template-columns: repeat(2, 1fr);
            }


            .channels-table {
                font-size: 0.8em;
            }


            .channels-table th,
            .channels-table td {
                padding: 8px;
            }


            .slider-container {
                min-width: 100px;
            }


            .input-container {
                flex-direction: column;
                gap: 5px;
            }


            .input-container input {
                width: 100%;
            }


            .btn-set {
                width: 100%;
            }


            .tabs {
                gap: 5px;
            }


            .tab-button {
                padding: 10px 15px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéõÔ∏è System & Modbus Control Panel</h1>
            <p>Real-time monitoring and control system</p>
        </div>


        <div class="tabs">
            <button class="tab-button active" data-tab="system">üìä System Metrics</button>
            <button class="tab-button" data-tab="modbus">üîß Modbus Channels</button>
            <button class="tab-button" data-tab="jetdata">üõ©Ô∏è Jet Data</button>
        </div>


        <!-- System Metrics Tab -->
        <div id="system" class="tab-content active">
            <div class="status-bar">
                <div class="status-item">
                    <label>CPU Usage</label>
                    <div class="value" id="cpuPercent">-<span class="unit">%</span></div>
                </div>
                <div class="status-item">
                    <label>Memory Usage</label>
                    <div class="value" id="memoryPercent">-<span class="unit">%</span></div>
                </div>
                <div class="status-item">
                    <label>Memory (Used/Total)</label>
                    <div class="value" id="memoryUsed">-<span class="unit">GB</span></div>
                </div>
                <div class="status-item">
                    <label>Swap Usage</label>
                    <div class="value" id="swapPercent">-<span class="unit">%</span></div>
                </div>
                <div class="status-item">
                    <label>CPU Temperature</label>
                    <div class="value" id="cpuTemp">-<span class="unit">¬∞C</span></div>
                </div>
                <div class="status-item">
                    <label>Last Update</label>
                    <div class="value" id="lastUpdate">-</div>
                </div>
                <div class="status-item">
                    <label>Connection Status</label>
                    <div class="value" id="connectionStatus">üî¥ Offline</div>
                </div>
                <div class="status-item">
                    <label>Requests</label>
                    <div class="value" id="requestCount">0</div>
                </div>
            </div>


            <div class="charts-grid">
                <div class="chart-container">
                    <h3>CPU Usage History</h3>
                    <div class="chart-wrapper">
                        <canvas id="cpuChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Memory Usage History</h3>
                    <div class="chart-wrapper">
                        <canvas id="memoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>


        <!-- Modbus Channels Tab -->
        <div id="modbus" class="tab-content">
            <div class="status-bar">
                <div class="status-item">
                    <label>Modbus Status</label>
                    <div class="value" id="modbusStatus">üî¥ Offline</div>
                </div>
                <div class="status-item">
                    <label>Last Update</label>
                    <div class="value" id="modbusLastUpdate">-</div>
                </div>
                <div class="status-item">
                    <label>Modbus Requests</label>
                    <div class="value" id="modbusRequestCount">0</div>
                </div>
                <div class="status-item">
                    <label>Modbus Errors</label>
                    <div class="value" id="modbusErrorCount">0</div>
                </div>
            </div>


            <div class="channels-section">
                <h2 class="section-title">Channel Control</h2>
                <table class="channels-table">
                    <thead>
                        <tr>
                            <th style="width: 80px;">Channel</th>
                            <th style="width: 80px;">Value</th>
                            <th>Slider</th>
                            <th style="width: 180px;">Direct Input</th>
                            <th style="width: 80px;">PWM (¬µs)</th>
                        </tr>
                    </thead>
                    <tbody id="channelsTableBody">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>


            <div class="feedback-message" id="feedbackMessage"></div>
        </div>


        <!-- System Metrics Tab -->
        <div id="jetdata" class="tab-content">
            <div class="status-bar">
                <div class="status-item">
                    <label>–û–±–æ—Ä–æ—Ç—ã</label>
                    <div class="value" id="cpuPercent">-<span class="unit">rpm/s</span></div>
                </div>
                <div class="status-item">
                    <label>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</label>
                    <div class="value" id="cpuPercent">-<span class="unit">deg</span></div>
                </div>
                <div class="status-item">
                    <label>–°–æ—Å—Ç–æ—è–Ω–∏–µ</label>
                    <div class="value" id="cpuPercent">-<span class="unit"></span></div>
                </div>
                <div class="status-item">
                    <label>–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ç–æ–ø–ª–∏–≤–∞</label>
                    <div class="value" id="cpuPercent">-<span class="unit">gr/s</span></div>
                </div>
                


            </div>


            <div class="charts-grid">
                <div class="chart-container">
                    <h3>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</h3>
                    <div class="chart-wrapper">
                        <canvas id="rpmChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>–û–±–æ—Ä–æ—Ç—ã</h3>
                    <div class="chart-wrapper">
                        <canvas id="tempChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ</h3>
                    <div class="chart-wrapper">
                        <canvas id="fuelChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="scripts/chart.min.js"></script>
    <script>
        // Configuration
        const API_URL = '/api';
        const SYSTEM_REFRESH_INTERVAL = 1000; // ms
        const MODBUS_REFRESH_INTERVAL = 500; // ms
        const SLIDER_DEBOUNCE = 100; // ms
        const MAX_CHART_POINTS = 60;


        // State
        let systemData = {};
        let channelsData = {};
        let sliderTimeouts = {};
        let systemRequestCount = 0;
        let modbusRequestCount = 0;
        let modbusErrorCount = 0;
        let isSystemConnected = false;
        let isModbusConnected = false;


        // Chart instances
        let cpuChart = null;
        let memoryChart = null;


        // Chart data buffers
        let chartData = {
            cpu: [],
            memory: [],
            timestamps: []
        };


        let jetchartData = {
            tepm: [],
            rpm: [],
            fuel: [],
            timestamps: []
        };


        /**
         * Convert percentage (-100 to 100) to PWM microseconds (500 to 2500)
         */
        function percentToPWM(percent) {
            // -100 -> 500¬µs, 0 -> 1500¬µs, 100 -> 2500¬µs
            return 1500 + (percent * 5);
        }


        /**
         * Initialize tabs
         */
        function initializeTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');


            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.dataset.tab;


                    // Deactivate all tabs
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));


                    // Activate selected tab
                    this.classList.add('active');
                    document.getElementById(tabName).classList.add('active');
                });
            });
        }


        /**
         * Initialize charts
         */
        function initializeCharts() {
            const chartConfig = {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#667eea',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        filler: true
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: '#667eea',
                                stepSize: 20
                            },
                            grid: {
                                color: 'rgba(102, 126, 234, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#667eea',
                                maxTicksLimit: 8
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            };


            const jet_chartConfig = {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#667eea',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        filler: true
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            // max: 100,
                            ticks: {
                                color: '#667eea',
                                stepSize: 20
                            },
                            grid: {
                                color: 'rgba(102, 126, 234, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#667eea',
                                maxTicksLimit: 8
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            };


            // CPU Chart
            cpuChart = new Chart(document.getElementById('cpuChart'), {
                ...jet_chartConfig,
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU %',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                }
            });


            // Memory Chart
            memoryChart = new Chart(document.getElementById('memoryChart'), {
                ...chartConfig,
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Memory %',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                }
            });


            // Jet Temp Chart
            tempChart = new Chart(document.getElementById('tempChart'), {
                ...jet_chartConfig,
                data: {
                    labels: [],
                    datasets: [{
                        label: 'degC',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                }
            });


            // Jet RPM Chart
            tempChart = new Chart(document.getElementById('rpmChart'), {
                ...jet_chartConfig,
                data: {
                    labels: [],
                    datasets: [{
                        label: 'RPM',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                }
            });


            // Jet fuel Chart
            tempChart = new Chart(document.getElementById('fuelChart'), {
                ...jet_chartConfig,
                data: {
                    labels: [],
                    datasets: [{
                        label: 'gr/s',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                }
            });
        }


        /**
         * Update charts with new data
         */
        function updateCharts(cpuPercent, memoryPercent) {
            const now = new Date().toLocaleTimeString();


            chartData.cpu.push(cpuPercent);
            chartData.memory.push(memoryPercent);
            chartData.timestamps.push(now);


            // Keep only last MAX_CHART_POINTS
            if (chartData.cpu.length > MAX_CHART_POINTS) {
                chartData.cpu.shift();
                chartData.memory.shift();
                chartData.timestamps.shift();
            }


            // Update CPU Chart
            cpuChart.data.labels = chartData.timestamps;
            cpuChart.data.datasets[0].data = chartData.cpu;
            cpuChart.update('none');


            // Update Memory Chart
            memoryChart.data.labels = chartData.timestamps;
            memoryChart.data.datasets[0].data = chartData.memory;
            memoryChart.update('none');
        }


        /**
         * Initialize Modbus channels table
         */
        function initializeChannelsTable() {
            const tbody = document.getElementById('channelsTableBody');
            tbody.innerHTML = '';


            for (let i = 0; i < 16; i++) {
                const row = createChannelRow(i);
                tbody.appendChild(row);
            }
        }


        /**
         * Create channel table row
         */
        function createChannelRow(channelNumber) {
            const row = document.createElement('tr');
            const channelKey = `chanel_${channelNumber}`;


            row.innerHTML = `
                <td class="channel-name">CH${channelNumber}</td>
                <td class="channel-value" id="value_${channelNumber}">-</td>
                <td>
                    <div class="slider-container">
                        <input type="range" class="slider" 
                               id="slider_${channelNumber}" 
                               min="-100" max="100" value="0"
                               data-channel="${channelNumber}">
                        <span class="slider-value" id="slider-value_${channelNumber}">0</span>
                    </div>
                </td>
                <td>
                    <div class="input-container">
                        <input type="number" id="input_${channelNumber}" 
                               min="-100" max="100" value="0"
                               placeholder="0"
                               data-channel="${channelNumber}">
                        <button class="btn-set" id="btn_${channelNumber}" 
                                data-channel="${channelNumber}">Send</button>
                    </div>
                </td>
                <td class="channel-value" id="pwm_${channelNumber}">1500</td>
            `;


            const slider = row.querySelector(`#slider_${channelNumber}`);
            const input = row.querySelector(`#input_${channelNumber}`);
            const button = row.querySelector(`#btn_${channelNumber}`);


            // Slider event
            slider.addEventListener('input', function(e) {
                const value = parseInt(this.value);
                const channel = parseInt(this.dataset.channel);


                document.getElementById(`slider-value_${channel}`).textContent = value;
                document.getElementById(`pwm_${channel}`).textContent = percentToPWM(value);


                if (sliderTimeouts[channel]) {
                    clearTimeout(sliderTimeouts[channel]);
                }


                sliderTimeouts[channel] = setTimeout(() => {
                    sendChannelValue(channel, value);
                    sliderTimeouts[channel] = null;
                }, SLIDER_DEBOUNCE);
            });


            // Input validation
            input.addEventListener('input', function(e) {
                let value = parseInt(this.value) || 0;
                if (value > 100) value = 100;
                if (value < -100) value = -100;
                this.value = value;
                document.getElementById(`pwm_${channelNumber}`).textContent = percentToPWM(value);
            });


            // Button click
            button.addEventListener('click', function() {
                const channel = parseInt(this.dataset.channel);
                const value = parseInt(input.value) || 0;
                sendChannelValue(channel, value);
            });


            // Enter key
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const channel = parseInt(this.dataset.channel);
                    const value = parseInt(this.value) || 0;
                    sendChannelValue(channel, value);
                }
            });


            return row;
        }


        /**
         * Send channel value to server
         */
        async function sendChannelValue(channel, value) {
            try {
                const response = await fetch(`${API_URL}/set_chanel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chanel: channel,
                        data: value
                    })
                });


                const data = await response.json();
                modbusRequestCount++;


                if (response.ok) {
                    showFeedback(`Channel ${channel} set to ${value}`, 'success');
                    document.getElementById(`input_${channel}`).value = value;
                } else {
                    modbusErrorCount++;
                    showFeedback(`Error: ${data.message}`, 'error');
                }
            } catch (error) {
                modbusErrorCount++;
                showFeedback(`Connection error: ${error.message}`, 'error');
            }


            updateModbusStats();
        }


        /**
         * Fetch system data
         */
        async function fetchSystemData() {
            try {
                const response = await fetch(`${API_URL}/`);
                const data = await response.json();
                systemRequestCount++;


                systemData = data;
                updateSystemDisplay();
                updateCharts(data.cpu_percent, data.memory_percent);
                isSystemConnected = true;
                updateConnectionStatus(true, 'system');
            } catch (error) {
                isSystemConnected = false;
                updateConnectionStatus(false, 'system');
                console.error('System data fetch error:', error);
            }
        }


        /**
         * Update system display
         */
        function updateSystemDisplay() {
            document.getElementById('cpuPercent').textContent = `${systemData.cpu_percent || 0}%`;
            document.getElementById('memoryPercent').textContent = `${systemData.memory_percent || 0}%`;
            document.getElementById('memoryUsed').textContent = 
                `${systemData.memory_used_gb || 0}/${systemData.memory_total_gb || 0}GB`;
            document.getElementById('swapPercent').textContent = `${systemData.swap_percent || 0}%`;
            document.getElementById('cpuTemp').textContent = `${systemData.cpu_temp || 0}¬∞C`;
            document.getElementById('lastUpdate').textContent = systemData.last_update || '-';
            document.getElementById('requestCount').textContent = systemRequestCount;
        }


        /**
         * Fetch Modbus data
         */
        async function fetchModbusData() {
            try {
                const response = await fetch(`${API_URL}/get_chanel`);
                const data = await response.json();
                modbusRequestCount++;


                channelsData = data;
                updateChannelsDisplay();
                isModbusConnected = true;
                updateConnectionStatus(true, 'modbus');
            } catch (error) {
                isModbusConnected = false;
                updateConnectionStatus(false, 'modbus');
                console.error('Modbus data fetch error:', error);
            }


            updateModbusStats();
        }


        /**
         * Update channels display
         */
        function updateChannelsDisplay() {
            for (let i = 0; i < 16; i++) {
                const channelKey = `chanel_${i}`;
                const value = channelsData[channelKey] || 0;


                const valueCell = document.getElementById(`value_${i}`);
                valueCell.textContent = value;
                valueCell.className = 'channel-value';


                if (value > 0) {
                    valueCell.classList.add('value-positive');
                } else if (value < 0) {
                    valueCell.classList.add('value-negative');
                } else {
                    valueCell.classList.add('value-zero');
                }


                document.getElementById(`pwm_${i}`).textContent = percentToPWM(value);


                const slider = document.getElementById(`slider_${i}`);
                if (!slider.dataset.userInteracting) {
                    slider.value = value;
                    document.getElementById(`slider-value_${i}`).textContent = value;
                }


                const input = document.getElementById(`input_${i}`);
                if (document.activeElement !== input) {
                    input.value = value;
                }
            }


            const now = new Date();
            document.getElementById('modbusLastUpdate').textContent = 
                now.toLocaleTimeString('en-US');
        }


        /**
         * Update connection status
         */
        function updateConnectionStatus(isConnected, type) {
            if (type === 'system') {
                const statusElement = document.getElementById('connectionStatus');
                statusElement.textContent = isConnected ? 'üü¢ Online' : 'üî¥ Offline';
                statusElement.style.color = isConnected ? '#27ae60' : '#e74c3c';
            } else if (type === 'modbus') {
                const statusElement = document.getElementById('modbusStatus');
                statusElement.textContent = isConnected ? 'üü¢ Online' : 'üî¥ Offline';
                statusElement.style.color = isConnected ? '#27ae60' : '#e74c3c';
            }
        }


        /**
         * Update Modbus stats
         */
        function updateModbusStats() {
            document.getElementById('modbusRequestCount').textContent = modbusRequestCount;
            document.getElementById('modbusErrorCount').textContent = modbusErrorCount;
        }


        /**
         * Show feedback message
         */
        function showFeedback(message, type) {
            const feedbackElement = document.getElementById('feedbackMessage');
            feedbackElement.textContent = message;
            feedbackElement.className = `feedback-message ${type}`;


            setTimeout(() => {
                feedbackElement.className = 'feedback-message';
            }, 3000);
        }


        /**
         * Initialize everything
         */
        function init() {
            console.log('üöÄ Initializing System & Modbus Control Panel...');
            
            initializeTabs();
            initializeCharts();
            initializeChannelsTable();


            // Initial data fetch
            fetchSystemData();
            fetchModbusData();


            // Periodic updates
            setInterval(fetchSystemData, SYSTEM_REFRESH_INTERVAL);
            setInterval(fetchModbusData, MODBUS_REFRESH_INTERVAL);


            // Slider interaction tracking
            document.querySelectorAll('.slider').forEach(slider => {
                slider.addEventListener('mousedown', function() {
                    this.dataset.userInteracting = 'true';
                });
                slider.addEventListener('mouseup', function() {
                    delete this.dataset.userInteracting;
                });
                slider.addEventListener('touchstart', function() {
                    this.dataset.userInteracting = 'true';
                });
                slider.addEventListener('touchend', function() {
                    delete this.dataset.userInteracting;
                });
            });


            console.log('‚úÖ Initialization complete');
        }


        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>